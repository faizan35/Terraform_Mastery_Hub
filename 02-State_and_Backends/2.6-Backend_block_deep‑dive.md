# 2.6 — Backend Block Deep-Dive

## 1. Partial Config & Env Var Injection

- The `backend` block defines **where state is stored** (e.g., S3, Azure Blob, GCS).
- You **don’t need to hardcode everything** inside it — you can leave it partially configured and inject the rest via CLI flags or environment variables.

**Example (partial config):**

```hcl
terraform {
  backend "s3" {
    bucket = "my-terraform-states"
    key    = "prod/app/terraform.tfstate"
    region = "ap-south-1"
  }
}
```

Instead of hardcoding creds:

```bash
export AWS_ACCESS_KEY_ID=xxxx
export AWS_SECRET_ACCESS_KEY=yyyy
terraform init
```

Or inject config dynamically:

```bash
terraform init \
  -backend-config="bucket=my-terraform-states" \
  -backend-config="region=ap-south-1"
```

Benefit: Same `backend.tf` works for **all envs**; only vars differ.

## 2. Workspace Key Prefixes & Naming

- When using **workspaces** with a remote backend, Terraform creates a **separate state file per workspace**.

**Example (S3 backend):**

```hcl
terraform {
  backend "s3" {
    bucket = "my-terraform-states"
    key    = "app/terraform.tfstate"
    region = "ap-south-1"
  }
}
```

- If you create workspaces (`dev`, `prod`), Terraform will store:

  ```
  app/dev/terraform.tfstate
  app/prod/terraform.tfstate
  ```

- This is controlled via **key prefixes**.
- Convention:

  - `project/env/component/terraform.tfstate`
  - Example: `crm/prod/network/terraform.tfstate`

Rule of thumb: Keep naming consistent — prevents overwrites and confusion.

## 3. Common Migration Gotchas (Local → Remote)

When migrating from **local** to **remote** backend:

- **Locks**

  - Some backends (S3+DynamoDB, Azure Blob) enforce locking.
  - If lock table/container not set up → migration may fail.
  - Fix: Create DynamoDB table or enable storage leases first.

- **Permissions**

  - Ensure CI/CD users and developers have **read/write** access to state bucket/container.
  - For prod: restrict to a small group.

- **Plan for downtime**

  - During migration, state is being moved. Avoid multiple people running `terraform apply`.

- **Backup first**

  - Always pull local state before migrating:

    ```bash
    terraform state pull > backup.json
    ```

- **Terraform init prompt**

  - First `terraform init` after adding backend block will ask:

    ```
    Do you want to copy existing state to the new backend?
    ```

    → Say **yes** to upload local state to remote.

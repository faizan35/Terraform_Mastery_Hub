# 2.2 — Remote State

## 1. Backends (Where state is stored)

Terraform uses **backends** to store state. In teams, we use **remote backends** instead of local files.

- **S3 Backend (AWS)**

  - State stored in S3 bucket.
  - Locking done with DynamoDB table (prevents concurrent `apply`).
  - Very common in AWS shops.
  - Pros: cheap, reliable, integrates with IAM.
  - Cons: must configure DynamoDB for locking, otherwise race conditions possible.

- **Azure Blob Backend (Azure)**

  - State stored in Azure Blob container.
  - Supports native state locking (via Azure Storage leases).
  - Pros: simple, built-in encryption, native integration with Azure AD RBAC.
  - Cons: slightly more complex setup vs S3 for some orgs.

- **GCS Backend (GCP)**

  - State stored in Google Cloud Storage bucket.
  - Locking with GCS object locks or external tools.
  - Pros: integrates with GCP IAM, simple.
  - Cons: less granular locking compared to DynamoDB.

## 2. Security & Access

- **Encryption:**

  - All major backends support at-rest encryption (S3 SSE, Azure Blob encryption, GCS CMEK).

- **Locking:**

  - Prevents two people from running `apply` at once (avoids corruption).
  - Implemented via DynamoDB (AWS), leases (Azure), or object locks (GCP).

- **IAM / RBAC:**

  - State files may contain sensitive info (IPs, passwords, ARNs).
  - Use fine-grained IAM/RBAC:

    - Read-only for CI/CD plan jobs.
    - Read/write for apply jobs.
    - Restrict prod access tightly.

## 3. Migrating Local → Remote (with care!)

- If you already have `terraform.tfstate` locally and want to move it:

  1. Configure backend block in Terraform:

     ```hcl
     terraform {
       backend "s3" {
         bucket         = "my-tf-states"
         key            = "prod/terraform.tfstate"
         region         = "ap-south-1"
         dynamodb_table = "terraform-locks"
       }
     }
     ```

  2. Run:

     ```bash
     terraform init
     ```

     Terraform will detect local state and **ask to migrate**.

  3. Confirm with `yes` → it uploads the local state to the backend.

- **Be careful:**

  - Don’t run `apply` from two places during migration.
  - Always take a backup of local `terraform.tfstate` before moving.

# 2.5 — State Surgery (Safely)

## 1. `terraform state mv`

- **Moves/renames resources inside the state file** without touching real infra.
- **Use case:**

  - Renaming a resource in code (`webserver → web`).
  - Migrating from `count` → `for_each`.

- **Example:**

  ```bash
  terraform state mv aws_instance.web[0] aws_instance.web["dev"]
  ```

- **Key point:** Prevents Terraform from destroying & recreating infra just because addresses changed.

## 2. `terraform state rm`

- **Removes a resource from state** (Terraform forgets it exists).
- Real infra stays, but Terraform won’t manage it anymore.
- **Use case:**

  - Stop managing a resource temporarily.
  - Let another stack take ownership.

- **Example:**

  ```bash
  terraform state rm aws_s3_bucket.legacy
  ```

## 3. `terraform state pull` / `terraform state push`

- **pull** → downloads current state as JSON.

  ```bash
  terraform state pull > backup.json
  ```

- **push** → replaces remote state with a local file.

  ```bash
  terraform state push backup.json
  ```

- **Use case:**

  - Backup & restore state.
  - Inspect state manually.

- **Danger:** Pushing bad state can corrupt infra management. Always back up first.

## 4. Mapping Addresses

- Every resource has an **address** in state:

  - `aws_instance.web`
  - `module.network.aws_vpc.main`
  - `aws_instance.web["prod"]`

- Knowing the address is key for surgery commands.

  ```bash
  terraform state list
  ```

  → Lists all current addresses in state.

## 5. Dry Runs & Backups

- **Dry run:**

  - Always run `terraform plan` after surgery to confirm no unintended creates/destroys.

- **Backups:**

  - Save current state before changes:

    ```bash
    terraform state pull > pre-surgery-backup.json
    ```

## 6. `terraform state replace-provider`

- **Purpose:** Update provider source addresses inside state.
- **Use case:**

  - Migrating provider namespace (e.g., `hashicorp/aws` → `registry.terraform.io/hashicorp/aws`).
  - Moving from a forked provider to the official one.

- **Example:**

  ```bash
  terraform state replace-provider \
    -auto-approve \
    registry.terraform.io/-/aws \
    registry.terraform.io/hashicorp/aws
  ```

## Golden Rules for State Surgery

1. Always **backup state** (`state pull`).
2. Prefer **`state mv`** instead of re-creating infra.
3. Use **`state rm`** carefully → it leaves “orphaned” resources.
4. After any surgery, **run `terraform plan`** to validate.
5. For teams: do surgery in **controlled downtime windows**.

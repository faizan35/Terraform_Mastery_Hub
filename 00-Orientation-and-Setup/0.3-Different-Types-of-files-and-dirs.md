# 0.3 - Terraform Files & Directories

## Core Configuration Files

- **`main.tf`**

  - Contains the primary resource definitions (the “what to build”).
  - Can be split into multiple `.tf` files; Terraform loads all of them.

- **`variables.tf`**

  - Declares input variables (name, type, default, description).
  - Makes modules and root configs reusable and parameterized.

- **`outputs.tf`**

  - Declares values to expose after apply (e.g., VPC ID, IPs).
  - Useful for chaining between modules or printing results.

- **`versions.tf`**

  - Specifies Terraform CLI and provider version constraints.
  - Helps prevent version drift across teams.

- **`provider.tf`** _(optional but common)_

  - Configures providers (AWS, Azure, GCP, Kubernetes, etc.).
  - Example: region, credentials, aliases.

- **`locals.tf`** _(optional)_

  - Stores reusable values/expressions.
  - Helps keep code DRY (no repeated strings or logic).

- **`backend.tf`** _(optional)_

  - Defines the backend (where state is stored: S3, GCS, Azure Blob, etc.).
  - Can also be inline in `main.tf`, but often kept separate.

## Variable & Environment Handling in Terraform

### 1. `terraform.tfvars`

Great comparison request — these two files are often confused. Let’s break it down cleanly:

---

## `terraform.tfvars` vs `terraform.tfstate`

### 1. **`terraform.tfvars`**

- A file where you define **input variable values** for your Terraform configuration.
- Example:

  ```hcl
  region      = "ap-south-1"
  instance_type = "t3.micro"
  ```

- **Purpose:**

  - Supplies inputs to variables declared in `variables.tf`.
  - Makes configs reusable across environments (dev, staging, prod).

### 2. `*.auto.tfvars`

- **Purpose:**

  - Auto-loaded like `terraform.tfvars`, but allows multiple files.
  - Great for **environment-specific** configs.

- **Example structure:**

  ```
  dev.auto.tfvars
  staging.auto.tfvars
  prod.auto.tfvars
  ```

  When you run `terraform apply`, Terraform automatically loads the one(s) present in the directory.

- **Use case:**

  - Useful in CI/CD pipelines where environment is decided by branch → drop the right `*.auto.tfvars` in place.

### 3. Custom `.tfvars` files

- **Purpose:**

  - Explicitly passed at runtime with `-var-file`.

- **Usage:**

  ```bash
  terraform apply -var-file=dev.tfvars
  terraform plan  -var-file=prod.tfvars
  ```

- **Use case:**

  - Cleaner than keeping multiple auto-loaded files in the same folder.
  - More explicit → reduces risk of applying wrong env accidentally.

## State & Lock Files in Terraform

### **`terraform.tfstate`**

In simple words, its the blueprint of the actual infrastructure creted.

#### 1. **When is it created?**

- The very first time you run `terraform apply` (or sometimes `terraform init` → `plan` → `apply`).
- Terraform generates the file automatically in your working directory.
- It’s updated every time Terraform makes a change (apply/destroy).

#### 2. **Why does it exist?**

- Terraform needs to **remember what it already built**.
- Cloud infra doesn’t “know” it was created by Terraform — so Terraform keeps its own memory.
- Without state, Terraform wouldn’t know whether to create something new, update, or destroy it.

### **`terraform.tfstate.backup`**

- **What it is:** Automatic backup of the previous state file.
- **Purpose:**

  - Safety net if the main `tfstate` gets corrupted or interrupted during apply.

- **Notes:**

  - Local only; no need to commit.

### **`terraform.tfplan`** _(optional, generated)_

- **What it is:** Binary file created if you run:

  ```bash
  terraform plan -out=tfplan
  ```

- **Purpose:**

  - Stores an exact plan to ensure deterministic apply later:

    ```bash
    terraform apply tfplan
    ```

  - Useful in CI/CD pipelines (separate “plan” and “apply” stages).

- **Notes:**

  - Machine-readable, not meant for Git.
  - Ephemeral — regenerate as needed.

### **`.terraform.lock.hcl`**

- **What it is:** Dependency lock file.
- **Purpose:**

  - Pins **exact provider versions** (with checksums).
  - Ensures consistent builds across team members and CI/CD.

- **Notes:**

  - **Yes, commit it** → it’s like `package-lock.json` in Node.js or `Pipfile.lock` in Python.

### **`.terraform.tfstate.lock.info`** _(ephemeral)_

- **What it is:** Temporary lock file created during `plan`/`apply`.
- **Purpose:**

  - Prevents concurrent operations modifying the same state at once.
  - Example: two people running `terraform apply` at the same time.

- **Notes:**

  - Auto-created and auto-deleted → don’t commit, don’t manage.

### **`.terraform/` directory**

- **What it is:** Local working directory created by `terraform init`.
- **Contents:** Provider binaries, downloaded modules, plugin cache.
- **Purpose:**

  - Speeds up Terraform runs by caching dependencies.

- **Notes:**

  - **Never commit** — always ignored in `.gitignore`.
  - Can safely delete; will be re-created by `terraform init`.

### Metadata & Documentation

- **`examples/` directory**

  - Contains sample usage of the module for quick adoption.

- **`modules/` directory**

  - Local reusable child modules.
  - Each subfolder contains its own `main.tf`, `variables.tf`, `outputs.tf`, etc.

- **`sentinel/` directory** _(Enterprise only)_

  - Stores Sentinel policies for policy-as-code (governance checks).

### Other Helpful Files

- **`.terraformrc` / `terraform.rc`**

  - User-level CLI config file.
  - Configures plugin cache dirs, credentials, provider mirrors.
  - Linux/Mac → `~/.terraformrc`
  - Windows → `%APPDATA%\terraform.rc`

- **`crash.log`** _(generated on crash)_

  - Terraform debug logs when a run fails unexpectedly.
  - Useful for troubleshooting and support.

- **`override.tf` / `*_override.tf`** _(rare)_

  - Overrides resource settings without touching original files.
  - Mostly for advanced/test scenarios.

- **`*.tf.json`**

  - JSON format of Terraform config (instead of HCL).
  - Useful when configs are generated programmatically.

- **`override.tf.json`**

  - JSON version of override files (rare).

- **`terraform.d/` (user home dir)**

  - Stores global Terraform data (credentials, cached plugins).
  - Different from `.terraform/` which is per-project.

- **`overrides/` directory (Terraform Enterprise/Cloud)**

  - Used for custom overrides in enterprise setups. Rare in OSS use.

## Terraform Production grade dir structure.

```
terraform-infra/
├── global/                        # Resources shared across environments (DNS, IAM org, S3 buckets, etc.)
│   ├── main.tf
│   ├── variables.tf
│   ├── outputs.tf
│   └── versions.tf
│
├── environments/                  # Each environment isolated (separate state + backend)
│   ├── dev/
│   │   ├── main.tf                # Calls modules with dev-specific vars
│   │   ├── variables.tf
│   │   ├── dev.tfvars             # Env values (non-sensitive)
│   │   ├── backend.tf             # Remote state backend config
│   │   └── provider.tf
│   │
│   ├── staging/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   ├── staging.tfvars
│   │   ├── backend.tf
│   │   └── provider.tf
│   │
│   └── prod/
│       ├── main.tf
│       ├── variables.tf
│       ├── prod.tfvars
│       ├── backend.tf
│       └── provider.tf
│
├── modules/                       # Reusable building blocks (DRY principle)
│   ├── network/                   # Example: VPC, subnets, gateways
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   ├── outputs.tf
│   │   └── versions.tf
│   │
│   ├── compute/                   # Example: EC2, ASG, Launch Templates
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   ├── outputs.tf
│   │   └── versions.tf
│   │
│   ├── storage/                   # Example: S3 buckets, EBS, EFS
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   ├── outputs.tf
│   │   └── versions.tf
│   │
│   └── database/                  # Example: RDS, DynamoDB
│       ├── main.tf
│       ├── variables.tf
│       ├── outputs.tf
│       └── versions.tf
│
├── examples/                      # Quick usage examples for new devs
│   └── simple-vpc/
│       └── main.tf
│
├── scripts/                       # Helper scripts (init, plan, apply wrappers)
│   ├── terraform-init.sh
│   ├── terraform-plan.sh
│   └── terraform-apply.sh
│
├── .terraform-version             # Pin Terraform version (used by tfenv/asdf)
├── .terraform.lock.hcl            # Provider versions lock file
├── .gitignore                     # Ignore state, .terraform/, plan files
└── README.md
```

#### Key Principles Behind This Layout

1. **Separation of Environments**

   - Each environment (`dev`, `staging`, `prod`) has its **own state file** and **backend config**.
   - Prevents a mistake in `dev` from touching `prod`.

2. **Reusable Modules**

   - All cloud building blocks (`network`, `compute`, `storage`, `database`) live in `modules/`.
   - Called from environment configs with environment-specific inputs.

3. **Global Resources**

   - Some resources (e.g., org-level IAM roles, DNS zones, global S3 buckets) belong in `global/`.

4. **Backend Isolation**

   - Each environment’s `backend.tf` points to a different key in remote storage (e.g., separate S3 prefixes):

     ```hcl
     backend "s3" {
       bucket = "my-terraform-states"
       key    = "prod/terraform.tfstate"
       region = "ap-south-1"
     }
     ```

5. **Version Pinning**

   - `.terraform-version` + `.terraform.lock.hcl` keep Terraform CLI and providers consistent across team and CI/CD.

6. **Security**

   - Sensitive values (`secrets`, `passwords`) not stored in `.tfvars` files; instead use CI/CD secret managers or environment variables (`TF_VAR_db_password`).

## Commit vs Ignore in Terraform Projects

### Commit to Git

- `main.tf`, `variables.tf`, `outputs.tf`, `versions.tf`, `provider.tf`, `locals.tf`, `backend.tf` → Core configuration and logic.
- `README.md` → Documentation.
- `examples/` → Example usage.
- `modules/` → Local child modules.
- `.terraform.lock.hcl` → Provider version lockfile (ensures reproducibility).
- `*.tf.json`, `override.tf.json` → JSON configs/overrides (if they are intentional configs).
- `sentinel/` (Enterprise only) → Policy-as-code.
- `.gitignore` → Git ignore rules.

### Do NOT Commit

- `terraform.tfstate` → Infra state (contains sensitive data).
- `terraform.tfstate.backup` → State backup file.
- `.terraform/` directory → Providers, modules cache (local only).
- `terraform.tfplan` → Saved binary plan file.
- `crash.log` → Debug info if Terraform crashes.
- `override.tf`, `*_override.tf` → Overrides for testing (temporary use).
- `.terraformrc` / `terraform.rc` → User CLI config (cache dir, creds).
- `.env` → Environment variables (secrets, creds).

### Maybe Commit (Depends on sensitivity)

- `terraform.tfvars` → Default variable values (commit only if non-sensitive).
- `*.auto.tfvars` → Auto-loaded variable files (safe if non-sensitive).
- Custom `dev.tfvars`, `prod.tfvars` → Environment-specific variables (commit only if non-sensitive).
